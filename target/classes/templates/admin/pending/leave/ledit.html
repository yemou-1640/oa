<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>编辑请假信息</title>
    <link th:href="@{/layuiadmin/layui/css/layui.css}" rel="stylesheet">
    <script th:src="@{/layuiadmin/layui/layui.js}"></script>
    <script src="/js/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="layui-form" lay-filter="leaveForm" style="padding: 20px;">
    <input type="hidden" name="lid" th:value="${leave.lid}">
    
    <div class="layui-form-item">
        <label class="layui-form-label">请假类型</label>
        <div class="layui-input-block">
            <select name="type" lay-verify="required">
                <option value="">请选择请假类型</option>
                <option value="事假" th:selected="${leave.type == '事假'}">事假</option>
                <option value="病假" th:selected="${leave.type == '病假'}">病假</option>
                <option value="年假" th:selected="${leave.type == '年假'}">年假</option>
            </select>
        </div>
    </div>
    
    <div class="layui-form-item">
        <label class="layui-form-label">开始时间</label>
        <div class="layui-input-block">
            <input type="text" name="startDate" th:value="${#dates.format(leave.startDate, 'yyyy-MM-dd HH:mm')}"
                   class="layui-input" id="startDate" lay-verify="required">
        </div>
    </div>
    
    <div class="layui-form-item">
        <label class="layui-form-label">结束时间</label>
        <div class="layui-input-block">
            <input type="text" name="endDate" th:value="${#dates.format(leave.endDate, 'yyyy-MM-dd HH:mm')}"
                   class="layui-input" id="endDate" lay-verify="required">
        </div>
    </div>
    
    <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">请假原因</label>
        <div class="layui-input-block">
            <textarea name="reason" placeholder="请输入请假原因" class="layui-textarea" lay-verify="required" th:text="${leave.reason}"></textarea>
        </div>
    </div>
    
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="saveBtn">保存</button>
            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
    </div>
</div>

<script src="/static/js/jquery-3.5.1.min.js" th:src="@{/js/jquery-3.5.1.min.js}"></script>
<script>
layui.use(['form', 'laydate', 'layer'], function(){
    var form = layui.form;
    var laydate = layui.laydate;
    var layer = layui.layer;
    var $ = layui.$;
    
    // 初始化日期选择器
    laydate.render({
        elem: '#startDate',
        type: 'datetime',
        format: 'yyyy-MM-dd HH:mm'
    });
    laydate.render({
        elem: '#endDate',
        type: 'datetime',
        format: 'yyyy-MM-dd HH:mm'
    });
    
    // 监听表单提交
    form.on('submit(saveBtn)', function(data){
        var field=data.field;
  
        // 转换日期为时间戳
        var startDate = new Date(field.startDate.replace(/-/g, '/')).getTime();
        var endDate = new Date(field.endDate.replace(/-/g, '/')).getTime();

        field.startDate = startDate;
        field.endDate = endDate;
        $.ajax({
            url: '/leave/edit',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data.field),
            success: function(res){
                if(res.code === 0){
                    layer.msg('保存成功', {
                        icon: 1,
                        time: 1000,
                        shade: [0.3, '#000']
                    }, function(){
                        // 刷新父页面表格
                        parent.layui.table.reload('leaveTable');
                        // 关闭所有弹窗
                        parent.layer.closeAll();
                        // 在父页面顶部显示成功提示
                        parent.layer.msg('请假信息已成功更新', {
                            offset: 't',
                            icon: 1
                        });
                    });
                } else {
                    layer.msg('保存失败：' + res.msg, {icon: 2});
                }
            },
            error: function(xhr){
                layer.msg('保存失败，请稍后重试', {icon: 2});
                console.error('Error:', xhr);
            }
        });
        return false;
    });
});
</script>
</body>
</html>